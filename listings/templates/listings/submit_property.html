{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Submit Property | ProEdge{% endblock %}

{% block content %}
<h2>Submit Property Listing</h2>
<a href="{% url 'dashboard_redirect' %}" class="btn btn-primary">üè† Back to Dashboard</a>

{% if form.errors %}
  <div class="alert alert-danger">
    <ul>
      {% for field in form %}
        {% for error in field.errors %}
          <li>{{ field.label }}: {{ error }}</li>
        {% endfor %}
      {% endfor %}
      {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
<form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <!-- ‚úÖ Basic Info -->
  <div class="property-info-section">
    <h3>Basic Details</h3>
    <div class="form-group">{{ form.title.label_tag }} {{ form.title }}</div>
    <div class="form-group">{{ form.description.label_tag }} {{ form.description }}</div>
    <div class="form-group">{{ form.province.label_tag }} {{ form.province }}</div>
    <div class="form-group">
      {{ form.location.label_tag }}
      {{ form.location }}
      <small class="form-text text-muted">Start typing the address and select from suggestions.</small>
    </div>
    <div class="form-group">{{ form.area.label_tag }} {{ form.area }}</div>
    <div class="form-group">{{ form.property_type.label_tag }} {{ form.property_type }}</div>
    <div class="form-group">{{ form.listing_type.label_tag }} {{ form.listing_type }}</div>
    <div class="form-group">{{ form.price.label_tag }} {{ form.price }}</div>
    <div class="form-group">{{ form.number_of_rooms.label_tag }} {{ form.number_of_rooms }}</div>
  </div>

  <!-- Hidden latitude and longitude fields (add these to your PropertyForm!) -->
  <input type="hidden" id="id_latitude" name="latitude" value="{{ form.latitude.value|default_if_none:'' }}">
  <input type="hidden" id="id_longitude" name="longitude" value="{{ form.longitude.value|default_if_none:'' }}">

  <!-- ‚úÖ Expandable Advanced Info -->
  <button type="button" id="toggle-advanced-btn" style="margin-top: 15px;">Add Additional Property Info</button>

  <div id="advanced-fields" style="display: none; margin-top: 15px;">
    <h4>Additional Property Info</h4>
    <div class="form-group">{{ form.number_of_bedrooms.label_tag }} {{ form.number_of_bedrooms }}</div>
    <div class="form-group">{{ form.number_of_kitchens.label_tag }} {{ form.number_of_kitchens }}</div>
    <div class="form-group">{{ form.number_of_bathrooms.label_tag }} {{ form.number_of_bathrooms }}</div>
    <div class="form-group">{{ form.number_of_garages.label_tag }} {{ form.number_of_garages }}</div>
    <div class="form-group">{{ form.floor_area_m2.label_tag }} {{ form.floor_area_m2 }}</div>
    <div class="form-group">{{ form.erf_size_m2.label_tag }} {{ form.erf_size_m2 }}</div>
    <div class="form-group">{{ form.price_per_m2.label_tag }} {{ form.price_per_m2 }}</div>
    <div class="form-group">{{ form.price_per_erf_m2.label_tag }} {{ form.price_per_erf_m2 }}</div>
    <div class="form-group">{{ form.has_parking.label_tag }} {{ form.has_parking }}</div>
    <div class="form-group">{{ form.number_of_parking_slots.label_tag }} {{ form.number_of_parking_slots }}</div>
  </div>

  <!-- Map Preview -->
  <div id="map" style="height: 400px; margin-top: 15px;"></div>

  <!-- ‚úÖ Submit -->
  <div style="margin-top: 30px;">
    <button type="submit">Submit Property</button>
  </div>
</form>


<!-- ‚úÖ JavaScript -->
<script>
  // Toggle additional fields
  document.getElementById('toggle-advanced-btn').addEventListener('click', function () {
    const section = document.getElementById('advanced-fields');
    section.style.display = (section.style.display === 'none') ? 'block' : 'none';
    this.textContent = section.style.display === 'none' ? 'Add Additional Property Info' : 'Hide Additional Info';
  });

  // Google Places Autocomplete & Map
  let map;
  let marker;

  function initMap() {
    // Initialize map centered on current lat/lng if available, else fallback
    const latInput = document.getElementById('id_latitude');
    const lngInput = document.getElementById('id_longitude');

    const lat = latInput.value ? parseFloat(latInput.value) : -33.918861;  // Example fallback: Cape Town
    const lng = lngInput.value ? parseFloat(lngInput.value) : 18.4233;

    const center = { lat: lat, lng: lng };

    map = new google.maps.Map(document.getElementById('map'), {
      center: center,
      zoom: 15,
    });

    marker = new google.maps.Marker({
      position: center,
      map: map,
      draggable: true,
    });

    // Update hidden fields when marker is dragged
    marker.addListener('dragend', function(event) {
      latInput.value = event.latLng.lat();
      lngInput.value = event.latLng.lng();
    });

    // Setup autocomplete on location input
    const input = document.getElementById('id_location');
    const autocomplete = new google.maps.places.Autocomplete(input);

    autocomplete.addListener('place_changed', function() {
      const place = autocomplete.getPlace();
      if (!place.geometry) {
        alert('No details available for input: "' + place.name + '"');
        return;
      }

      // Update map center & marker position
      const location = place.geometry.location;
      map.setCenter(location);
      marker.setPosition(location);

      // Update hidden fields
      latInput.value = location.lat();
      lngInput.value = location.lng();
    });
  }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCd3bl10Viq12p8pxNP2dPqV-veDWfF5ac&libraries=places&callback=initMap" defer>
</script>

<script>
  // The existing code for your buttons (image upload, etc.) can remain here
  // Make sure any event listeners on buttons are wrapped in DOMContentLoaded if necessary
</script>

{% endblock %}
