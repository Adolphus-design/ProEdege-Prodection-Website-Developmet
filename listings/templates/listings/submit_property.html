{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Submit Property | ProEdge{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center text-danger fw-bold mb-4">Submit Property Listing</h2>

    <div class="mb-3 text-center">
        <a href="{% url 'dashboard_redirect' %}" class="btn btn-primary fw-bold px-4">üè† Back to Dashboard</a>
    </div>

    {% if form.errors %}
        <div class="alert alert-danger">
            <ul class="mb-0">
                {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="glass-card mx-auto">
        {% csrf_token %}

        <!-- Basic Details -->
        <h4 class="text-white mb-3">Basic Details</h4>
        <div class="row g-3">
            {% for field in form %}
                {% if field.name in form.basic_fields %}
                    <div class="col-md-6 col-12">
                        <label for="{{ field.id_for_label }}" class="form-label text-white fw-semibold">{{ field.label }}</label>
                        {{ field|add_class:"form-control form-control-dark text-white bg-black bg-opacity-50 border border-secondary rounded" }}
                        {% if field.help_text %}
                            <small class="form-text text-muted">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <div class="text-danger mt-1">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Hidden latitude and longitude fields -->
        <input type="hidden" id="id_latitude" name="latitude" value="{{ form.latitude.value|default_if_none:'' }}">
        <input type="hidden" id="id_longitude" name="longitude" value="{{ form.longitude.value|default_if_none:'' }}">

        <!-- Advanced Fields Toggle -->
        <button type="button" id="toggle-advanced-btn" class="btn btn-danger mt-4 mb-3 w-100">Add Additional Property Info</button>

        <div id="advanced-fields" style="display: none;">

            <!-- Property Specs -->
            <h5 class="advanced-section-heading btn-danger">Property Specs</h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name in form.property_specs_fields %}
                        <div class="col-md-6 col-12">
                            <label for="{{ field.id_for_label }}" class="form-label text-white fw-semibold">{{ field.label }}</label>
                            {{ field|add_class:"form-control form-control-dark text-white bg-black bg-opacity-50 border border-secondary rounded" }}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Property Features -->
            <h5 class="advanced-section-heading">Property Features</h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name in form.property_features_fields %}
                        <div class="col-md-6 col-12">
                            {% if field.field.widget.input_type == 'checkbox' %}
                                <div class="form-check text-white">
                                    {{ field|add_class:"form-check-input" }}
                                    <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                </div>
                            {% else %}
                                <label for="{{ field.id_for_label }}" class="form-label text-white fw-semibold">{{ field.label }}</label>
                                {{ field|add_class:"form-control form-control-dark text-white bg-black bg-opacity-50 border border-secondary rounded" }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Lease / Rental Details -->
            <h5 class="advanced-section-heading">Lease / Rental Details</h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name in form.lease_fields %}
                        <div class="col-md-6 col-12">
                            <label for="{{ field.id_for_label }}" class="form-label text-white fw-semibold">{{ field.label }}</label>
                            {% if field.field.widget.input_type == 'date' %}
                                {{ field|add_class:"form-control form-control-dark text-white bg-black bg-opacity-50 border border-secondary rounded" }}
                            {% else %}
                                {{ field|add_class:"form-control form-control-dark text-white bg-black bg-opacity-50 border border-secondary rounded" }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- Mandate / Commission Details -->
            <h5 class="advanced-section-heading">Mandate / Commission Details</h5>
            <div class="row g-3">
                {% for field in form %}
                    {% if field.name in form.mandate_fields %}
                        <div class="col-md-6 col-12">
                            <label for="{{ field.id_for_label }}" class="form-label text-white fw-semibold">{{ field.label }}</label>
                            {% if field.field.widget.input_type == 'date' %}
                                {{ field|add_class:"form-control form-control-dark text-white bg-black bg-opacity-50 border border-secondary rounded" }}
                            {% else %}
                                {{ field|add_class:"form-control form-control-dark text-white bg-black bg-opacity-50 border border-secondary rounded" }}
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

        </div>

        <!-- Map Preview -->
        <div id="map" style="height: 400px; margin-top: 20px;"></div>

        <!-- Submit -->
        <div class="mt-4 text-center">
            <button type="submit" class="btn btn-danger fw-bold px-5 shadow-sm">Submit Property</button>
        </div>
    </form>
</div>

<!-- Glass Card CSS -->
<style>
.glass-card {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    padding: 2rem;
    transition: all 0.3s ease-in-out;
}
.glass-card:hover {
    box-shadow: 0 12px 48px 0 rgba(0, 0, 0, 0.5);
    transform: translateY(-2px);
}
.form-control-dark {
    transition: all 0.3s ease-in-out;
}
.form-control-dark:focus {
    box-shadow: 0 0 0 0.2rem rgba(184, 7, 7, 0.25);
    border-color: #b80707;
    background-color: #1a1a1a;
    color: #fff;
}
button.btn-danger:hover {
    background-color: #a00505;
    border-color: #a00505;
    transform: scale(1.02);
    transition: all 0.2s ease-in-out;
}
button.btn-secondary:hover {
    transform: scale(1.02);
    transition: all 0.2s ease-in-out;
}


.advanced-section-heading {
    font-weight: 700;           /* bold */
    color: #fff;                /* white text */
    text-align: center;          /* center alignment */
    border-bottom: 2px solid #b80707; /* red underline */
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    font-size: 1.25rem;         /* slightly larger font */
}
</style>

<!-- JS -->
<script>
    // Toggle advanced fields
    const toggleBtn = document.getElementById('toggle-advanced-btn');
    const advancedFields = document.getElementById('advanced-fields');
    toggleBtn.addEventListener('click', () => {
        advancedFields.style.display = advancedFields.style.display === 'none' ? 'block' : 'none';
        toggleBtn.textContent = advancedFields.style.display === 'none' ? 'Add Additional Property Info' : 'Hide Additional Info';
    });

    // Google Maps & Places Autocomplete
    let map, marker;
    function initMap() {
        const latInput = document.getElementById('id_latitude');
        const lngInput = document.getElementById('id_longitude');
        const lat = latInput.value ? parseFloat(latInput.value) : -33.918861;
        const lng = lngInput.value ? parseFloat(lngInput.value) : 18.4233;
        const center = { lat: lat, lng: lng };

        map = new google.maps.Map(document.getElementById('map'), { center: center, zoom: 15 });
        marker = new google.maps.Marker({ position: center, map: map, draggable: true });

        marker.addListener('dragend', function(event) {
            latInput.value = event.latLng.lat();
            lngInput.value = event.latLng.lng();
        });

        const input = document.getElementById('id_location');
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (!place.geometry) return alert('No details available for input: "' + place.name + '"');
            const location = place.geometry.location;
            map.setCenter(location);
            marker.setPosition(location);
            latInput.value = location.lat();
            lngInput.value = location.lng();
        });
    }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCd3bl10Viq12p8pxNP2dPqV-veDWfF5ac&libraries=places&callback=initMap" defer>
</script>

{% endblock %}
