{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">
  <div class="container" style="margin-top:80px;">
    <h2 class="mb-3 text-center">Available Properties in South Africa</h2>
  </div>

  <hr>

  <!-- Top section: Map (left) + Province Filter (right) 
  <div style="display: flex; gap: 20px; margin-bottom: 30px;"

    Left: SVG Map 
    <div class="sa-map-container" style="width:59%; margin-left:0;">
    <object id="sa-map" type="image/svg+xml" data="{% static 'maps/south_africa.svg' %}" style="width:100%;"></object>
</div>

     Right: Province Filter / Sub-area panel 
    <div id="province-panel" style="flex-grow:1; border: 1px solid #ccc; padding: 15px; min-height: 300px;">
      <h4>Select a province</h4>
      <p>Click a province on the map to see regions here...</p>
      <ul id="subareas" style="list-style:none; padding-left:0;"></ul>
    </div>

    
  </div>
<hr>
-->
  <!-- Property Grid -->
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {% for property in properties %}
      <div class="col">
        <div class="card h-100 shadow-sm position-relative border">

          <!-- SOLD badge -->
          {% if property.status == 'sold' %}
            <div class="position-absolute top-0 start-0 bg-danger text-white px-3 py-1 fw-bold rounded-end">
              SOLD
            </div>
          {% endif %}

          <!-- Agency Logo (if exists) -->
          {% if property.agent.agentprofile and property.agent.agentprofile.agency and property.agent.agentprofile.agency.logo %}
            <img src="{{ property.agent.agentprofile.agency.logo.url }}" 
                 alt="{{ property.agent.agentprofile.agency.name }} Logo"
                 class="position-absolute top-0 end-0 m-2" 
                 style="width: 50px; height: 50px; object-fit: contain; border-radius:5px;">
          {% endif %}

          <!-- Image -->
          <a href="{% url 'property_detail' property.id %}">
            {% with main_image_url=property.get_main_image_url %}
              {% if main_image_url %}
                <img src="{{ main_image_url }}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="Property image">
              {% else %}
                <img src="{% static 'images/default.jpg' %}" class="card-img-top" style="height: 200px; object-fit: cover;" alt="Default image">
              {% endif %}
            {% endwith %}
          </a>

          <!-- Body -->
          <div class="card-body">
            <h5 class="card-title">{{ property.title }}</h5>
            <p class="card-text text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i> {{ property.location }} | {{ property.province }}</p>
            <p class="text-danger fw-bold fs-5">R {{ property.price|floatformat:0 }}</p>

            <div class="d-flex justify-content-start gap-3 text-secondary small mt-2">
              {% if property.number_of_bedrooms %}
                <span><i class="fas fa-bed me-1"></i> {{ property.number_of_bedrooms }}</span>
              {% endif %}
              {% if property.number_of_bathrooms %}
                <span><i class="fas fa-shower me-1"></i> {{ property.number_of_bathrooms }}</span>
              {% endif %}
              {% if property.number_of_garages %}
                <span><i class="fas fa-warehouse me-1"></i> {{ property.number_of_garages }}</span>
              {% endif %}
            </div>

            <a href="{% url 'property_detail' property.id %}" class="btn btn-dark btn-sm mt-3 w-100">
              View Details
            </a>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center text-muted">No properties available at the moment.</p>
    {% endfor %}
  </div>
</div>

<script>
  // Example: Map click handling to show sub-areas in the right panel
  document.querySelectorAll('#sa-map path, #sa-map polygon').forEach(region => {
      const provinceName = region.getAttribute('id') || region.getAttribute('data-name');

      region.addEventListener('click', () => {
          const subareasList = document.getElementById('subareas');
          subareasList.innerHTML = ''; // Clear previous
          
          // Example subareas (replace with real data later)
          const exampleSubareas = ['Area 1', 'Area 2', 'Area 3', 'Area 4'];
          exampleSubareas.forEach(area => {
              const li = document.createElement('li');
              li.textContent = area;
              li.style.cursor = 'pointer';
              li.style.marginBottom = '5px';
              li.addEventListener('click', () => {
                  // Redirect to properties for this subarea
                  alert('Show properties for ' + area + ' in ' + provinceName);
              });
              subareasList.appendChild(li);
          });
      });
  });
</script>

<style>
  #sa-map path, #sa-map polygon {
    fill: #c0c0c0;       /* Default province color */
    stroke: #000;         /* Border */
    stroke-width: 0.5;
    transition: fill 0.3s; /* Smooth hover effect */
  }

  #sa-map path:hover, #sa-map polygon:hover {
      fill: #ff0000;        /* Highlight on hover */
      cursor: pointer;
  }
</style>

{% endblock %}
