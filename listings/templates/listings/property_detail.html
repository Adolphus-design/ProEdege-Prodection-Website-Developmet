{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">

    {% if request.user.is_authenticated %}
<div class="mb-3">
  <a href="{% url 'dashboard_redirect' %}" class="btn btn-danger fw-bold rounded-pill px-4 shadow-sm">
    ‚Üê Back to Dashboard
  </a>
</div>
{% endif %}

  <!-- Main Image + Overlay -->
{% with main_image_url=property.get_main_image_url %}
    {% if main_image_url %}
        <div class="position-relative mb-4">
            <img src="{{ main_image_url }}" class="img-fluid rounded w-100" style="height: 400px; object-fit: cover;" alt="Property-image">

            <!-- Overlay Card -->
            <div class="position-absolute top-0 start-0 bg-dark bg-opacity-75 text-white p-3 rounded m-3" style="max-width: 340px;">
                <h4 class="mb-2">{{ property.title }}</h4>
                <p class="mb-2"><i class="fas fa-map-marker-alt me-1"></i> {{ property.location }}, {{ property.province }}</p>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h4 class="mb-0 text-danger fw-bold">R{{ property.price|floatformat:0 }}</h4>
                    <a href="{% url 'submit_interest' property.id %}" class="btn btn-danger btn-sm">Make Offer</a>
                </div>
                <div class="d-flex gap-3 mt-3 small">
                    {% if property.number_of_bedrooms %}<span><i class="fas fa-bed"></i> {{ property.number_of_bedrooms }}</span>{% endif %}
                    {% if property.number_of_bathrooms %}<span><i class="fas fa-shower"></i> {{ property.number_of_bathrooms }}</span>{% endif %}
                    {% if property.number_of_kitchens %}<span><i class="fas fa-utensils"></i> {{ property.number_of_kitchens }}</span>{% endif %}
                    {% if property.number_of_garages %}<span><i class="fas fa-warehouse"></i> {{ property.number_of_garages }}</span>{% endif %}
                </div>
            </div>
        </div>
    {% else %}
        <img src="{% static 'images/default.jpg' %}" class="img-fluid rounded w-100" style="height: 400px; object-fit: cover;" alt="Default image">
    {% endif %}
{% endwith %}

  <!-- Quick Nav Buttons -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <a href="#overview" class="btn btn-outline-dark btn-sm"><i class="fas fa-home me-1"></i> Overview</a>
    <a href="#seller" class="btn btn-outline-dark btn-sm"><i class="fas fa-user me-1"></i> Seller Info</a>
    <a href="#features" class="btn btn-outline-dark btn-sm"><i class="fas fa-list me-1"></i> Key Features</a>
    <a href="#lightgallery" class="btn btn-outline-dark btn-sm"><i class="fas fa-images me-1"></i> Gallery</a>
    <a href="#map" class="btn btn-outline-dark btn-sm"><i class="fas fa-map-marked-alt me-1"></i> Map</a>
  </div>

  <!-- Overview & Seller Side-by-Side -->
  <div class="row mb-5">
    <div class="col-md-8" id="overview">
      <h5 class="mb-3 border-bottom pb-2">Property Overview</h5>
      <p>{{ property.description }}</p>
    </div>
    <div class="col-md-4" id="seller">

    <!---->
      <h5 class="mb-3 border-bottom pb-2">Agent(s) Marketing This Property</h5>

<h5 class="mb-3 border-bottom pb-2">Agent(s) Marketing This Property</h5>

<div class="d-flex flex-column gap-3">

    {# Multiple agents (linked to agency) #}
    {% if property.agents.all %}
        {% for agent in property.agents.all %}
            <div class="bg-black bg-opacity-80 text-white p-3 rounded shadow-sm d-flex align-items-center gap-3">
                
                <!-- Profile / Agency Logo -->
                <div class="d-flex align-items-center gap-2">
                    {% if agent.userprofile.profile_picture %}
                        <img src="{{ agent.userprofile.profile_picture.url }}" alt="Profile Picture"
                             class="rounded-circle border" style="width: 80px; height: 80px; object-fit: cover;">
                    {% elif agent.agency and agent.agency.logo %}
                        <img src="{{ agent.agency.logo.url }}" alt="{{ agent.agency.name }} Logo"
                             class="border rounded" style="width: 80px; height: 80px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center text-white fw-bold"
                             style="width: 80px; height: 80px;">
                            {{ agent.username|first|upper }}
                        </div>
                    {% endif %}
                </div>

                <!-- Agent Info and Contact -->
                <div>
                    <p class="mb-1 fw-semibold">{{ agent.get_full_name|default:agent.username }}</p>
                    {% if agent.agency %}
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="text-gray-300 small">Agent at {{ agent.agency.name }}</span>
                        </div>
                    {% endif %}
                    <div class="d-flex gap-2">
                        {% if agent.userprofile.contact_number %}
                            <a href="tel:{{ agent.userprofile.contact_number }}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-phone"></i> Call
                            </a>
                            <a href="https://wa.me/{{ agent.userprofile.contact_number }}" class="btn btn-success btn-sm">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                        {% endif %}
                        {% if agent.email %}
                            <a href="mailto:{{ agent.email }}" class="btn btn-danger btn-sm">
                                <i class="fas fa-envelope"></i> Email
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    {# Standalone agent if not already in property.agents #}
    {% if property.agent and property.agent not in property.agents.all %}
        <div class="bg-black bg-opacity-80 text-white p-3 rounded shadow-sm d-flex align-items-center gap-3">
            {% if property.agent.userprofile.profile_picture %}
                <img src="{{ property.agent.userprofile.profile_picture.url }}" alt="Profile Picture"
                     class="rounded-circle border" style="width: 80px; height: 80px; object-fit: cover;">
            {% elif property.agent.agency and property.agent.agency.logo %}
                <img src="{{ property.agent.agency.logo.url }}" alt="{{ property.agent.agency.name }} Logo"
                     class="border rounded" style="width: 80px; height: 80px; object-fit: cover;">
            {% else %}
                <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center text-white fw-bold"
                     style="width: 80px; height: 80px;">
                    {{ property.agent.username|first|upper }}
                </div>
            {% endif %}

            <div>
                <p class="mb-1 fw-semibold">{{ property.agent.get_full_name|default:property.agent.username }}</p>
                {% if property.agent.agency %}
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="text-gray-300 small">Agent at {{ property.agent.agency.name }}</span>
                    </div>
                {% endif %}
                <div class="d-flex gap-2">
                    {% if property.agent.userprofile.contact_number %}
                        <a href="tel:{{ property.agent.userprofile.contact_number }}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-phone"></i> Call
                        </a>
                        <a href="https://wa.me/{{ property.agent.userprofile.contact_number }}" class="btn btn-success btn-sm">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    {% endif %}
                    {% if property.agent.email %}
                        <a href="mailto:{{ property.agent.email }}" class="btn btn-danger btn-sm">
                            <i class="fas fa-envelope"></i> Email
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    {# Fallback seller (non-agent) #}
    {% if property.seller %}
        <div class="bg-black bg-opacity-80 text-white p-3 rounded shadow-sm d-flex align-items-center gap-3">
            {% if property.seller.userprofile.profile_picture %}
                <img src="{{ property.seller.userprofile.profile_picture.url }}" alt="Profile Picture"
                     class="rounded-circle border" style="width: 80px; height: 80px; object-fit: cover;">
            {% else %}
                <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center text-white fw-bold"
                     style="width: 80px; height: 80px;">
                    {{ property.seller.username|first|upper }}
                </div>
            {% endif %}

            <div>
                <p class="mb-1 fw-semibold">{{ property.seller.get_full_name|default:property.seller.username }}</p>
                <div class="d-flex gap-2">
                    {% if property.seller.userprofile.contact_number %}
                        <a href="tel:{{ property.seller.userprofile.contact_number }}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-phone"></i> Call
                        </a>
                        <a href="https://wa.me/{{ property.seller.userprofile.contact_number }}" class="btn btn-success btn-sm">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    {% endif %}
                    {% if property.seller.email %}
                        <a href="mailto:{{ property.seller.email }}" class="btn btn-danger btn-sm">
                            <i class="fas fa-envelope"></i> Email
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

</div>


    </div>
  </div>

<!-- Key Features -->
<div id="features" class="mb-5">
    <h5 class="mb-3 border-bottom pb-2">Key Features</h5>
    <div class="row g-3">

        {% if property.number_of_bedrooms %}
            <div class="col-6 col-md-3"><strong>Bedrooms:</strong> {{ property.number_of_bedrooms }}</div>
        {% endif %}

        {% if property.number_of_bathrooms %}
            <div class="col-6 col-md-3"><strong>Bathrooms:</strong> {{ property.number_of_bathrooms }}</div>
        {% endif %}

        {% if property.number_of_kitchens %}
            <div class="col-6 col-md-3"><strong>Kitchens:</strong> {{ property.number_of_kitchens }}</div>
        {% endif %}

        {% if property.number_of_garages %}
            <div class="col-6 col-md-3"><strong>Garages:</strong> {{ property.number_of_garages }}</div>
        {% endif %}

        {% if property.floor_area_m2 %}
            <div class="col-6 col-md-3"><strong>Floor Area:</strong> {{ property.floor_area_m2 }} m¬≤</div>
        {% endif %}

        {% if property.erf_size_m2 %}
            <div class="col-6 col-md-3"><strong>Erf Size:</strong> {{ property.erf_size_m2 }} m¬≤</div>
        {% endif %}

        {% if property.listing_type %}
            <div class="col-6 col-md-3"><strong>Listing Type:</strong> {{ property.listing_type }}</div>
        {% endif %}

        {% if property.price_per_m2 %}
            <div class="col-6 col-md-3"><strong>Price per m¬≤:</strong> R {{ property.price_per_m2|floatformat:0 }}</div>
        {% endif %}

        {% if property.price_per_erf_m2 %}
            <div class="col-6 col-md-3"><strong>Price per Erf m¬≤:</strong> R {{ property.price_per_erf_m2|floatformat:0 }}</div>
        {% endif %}

        {% if property.has_parking %}
            <div class="col-6 col-md-3">
                <strong>Parking:</strong> Yes
                {% if property.number_of_parking_slots and property.number_of_parking_slots != "N/A" %}
                    ({{ property.number_of_parking_slots }} slots)
                {% endif %}
            </div>
        {% endif %}

    </div>
</div>


  <!-- Gallery -->
  <div id="lightgallery" class="row g-3">
    {% for image in images %}
        {% if image.image %}
            <div class="col-6 col-md-3">
                <a href="{{ image.image.url }}" class="gallery-item">
                    <img src="{{ image.image.url }}" class="img-fluid rounded" alt="Gallery Image">
                </a>
            </div>
        {% endif %}
    {% endfor %}
  </div>

  <hr>

<!-- Map View -->
<div id="map" class="mb-5" style="height: 400px;"></div>

{% if property.latitude and property.longitude %}
<script>
  function initMap() {
    const propertyLocation = { 
      lat: {{ property.latitude|default:"0" }}, 
      lng: {{ property.longitude|default:"0" }} 
    };

    const map = new google.maps.Map(document.getElementById('map'), {
      zoom: 15,
      center: propertyLocation,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false
    });

    new google.maps.Marker({
      position: propertyLocation,
      map: map
    });
  }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCd3bl10Viq12p8pxNP2dPqV-veDWfF5ac&callback=initMap">
</script>
{% else %}
<div class="rounded-lg shadow-lg w-full h-64 flex items-center justify-center bg-gray-100 text-gray-500 text-center">
  <p>No location coordinates provided for this property.</p>
</div>
{% endif %}


<!-- Other Actions -->
<div class="mb-5">
    <h5 class="mb-3 border-bottom pb-2">Other Actions</h5>
    <div class="d-flex flex-wrap gap-2">

        <!-- Make Offer -->
        <a href="{% url 'submit_interest' property.id %}"
           class="btn btn-danger btn-sm d-flex align-items-center gap-1">
            <i class="fas fa-handshake"></i> Make Offer
        </a>

        <!-- Request More Info -->
        {% if user.is_authenticated %}
           <a href=""
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-info-circle"></i> Request Info
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to request info">
                <i class="fas fa-info-circle"></i> Request Info
            </a>
        {% endif %}

        <!-- Save Property -->
        {% if user.is_authenticated %}
            <form method="post" action="" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                    <i class="fas fa-bookmark"></i> Save
                </button>
            </form>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to save property">
                <i class="fas fa-bookmark"></i> Save
            </a>
        {% endif %}

        <!-- Share Property -->
        <button type="button"
                class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
                onclick="navigator.clipboard.writeText(window.location.href); alert('Property link copied!')">
            <i class="fas fa-share"></i> Share
        </button>

        <!-- Boost / Promote -->
        {% if user.is_authenticated %}
            <a href=""
               class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-bolt"></i> Boost
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1"
               title="Login to boost property">
                <i class="fas fa-bolt"></i> Boost
            </a>
        {% endif %}

        <!-- Compare Property -->
        <button type="button" class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
                onclick="addToCompare({{ property.id }})">
            <i class="fas fa-exchange-alt"></i> Compare
        </button>

        <!-- Print Property -->
        <button type="button" class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
                onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>

        <!-- Report Property -->
        {% if user.is_authenticated %}
            <a href=""
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-flag"></i> Report
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to report property">
                <i class="fas fa-flag"></i> Report
            </a>
        {% endif %}

        <!-- Request Valuation -->
        {% if user.is_authenticated %}
            <a href=""
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-chart-line"></i> Request Valuation
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to request valuation">
                <i class="fas fa-chart-line"></i> Request Valuation
            </a>
        {% endif %}

    </div>
</div>



<!-- LightGallery Script -->
<link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    lightGallery(document.getElementById("lightgallery"), {
      selector: '.gallery-item',
      plugins: [lgZoom],
      mode: 'lg-slide',
      speed: 600,
      thumbnail: true,
      download: false
    });
  });
</script>

{% endblock %}
