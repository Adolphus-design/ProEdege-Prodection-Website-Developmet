{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-5">

    {% if request.user.is_authenticated %}
    <div class="mb-3">
      <a href="{% url 'dashboard_redirect' %}" class="btn btn-danger fw-bold rounded-pill px-4 shadow-sm">
        ← Back to Dashboard
      </a>
    </div>
    {% endif %}

    <!-- Main Image + Overlay -->
    {% with main_image_url=property.get_main_image_url %}
        {% if main_image_url %}
            <div class="position-relative mb-4">
                <img src="{{ main_image_url }}" class="img-fluid rounded w-100" style="height: 400px; object-fit: cover;" alt="Property-image">

                <!-- Overlay Card -->
                <div class="position-absolute top-0 start-0 bg-dark bg-opacity-75 text-white p-3 rounded m-3" style="max-width: 340px;">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">{{ property.title }}</h4>
        {% if property.ownership_type %}
            <span class="badge bg-danger text-light ms-4">{{ property.get_ownership_type_display }}</span>
        {% endif %}
    </div>

    <p class="mb-2">
        <i class="fas fa-map-marker-alt me-1"></i> {{ property.location }}, {{ property.province }}
    </p>

    <div class="d-flex flex-column mb-2">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <h4 class="mb-0 text-danger fw-bold">R{{ property.price|floatformat:0 }}</h4>
            <a href="{% url 'submit_interest' property.id %}" class="btn btn-danger btn-sm">Make Offer</a>
        </div>

        {# Display property_type badge if ownership_type is neither Sectional nor Freehold #}
        {% if property.ownership_type != "Sectional Title" and property.ownership_type != "Freehold" and property.property_type %}
            <span class="badge bg-danger text-white mt-2">{{ property.property_type }}</span>

        {% endif %}
    </div>

    <div class="d-flex gap-3 mt-3 small">
        {% if property.number_of_bedrooms %}<span><i class="fas fa-bed"></i> {{ property.number_of_bedrooms }}</span>{% endif %}
        {% if property.number_of_bathrooms %}<span><i class="fas fa-shower"></i> {{ property.number_of_bathrooms }}</span>{% endif %}
        {% if property.number_of_kitchens %}<span><i class="fas fa-utensils"></i> {{ property.number_of_kitchens }}</span>{% endif %}
        {% if property.number_of_garages %}<span><i class="fas fa-warehouse"></i> {{ property.number_of_garages }}</span>{% endif %}
    </div>
</div>
            </div>
        {% else %}
            <img src="{% static 'images/default.jpg' %}" class="img-fluid rounded w-100" style="height: 400px; object-fit: cover;" alt="Default image">
        {% endif %}
    {% endwith %}

    <!-- Quick Nav Buttons -->
    <div class="d-flex flex-wrap gap-2 mb-4">
      <a href="#overview" class="btn btn-outline-dark btn-sm"><i class="fas fa-home me-1"></i> Overview</a>
      <a href="#seller" class="btn btn-outline-dark btn-sm"><i class="fas fa-user me-1"></i> Seller Info</a>
      <a href="#features" class="btn btn-outline-dark btn-sm"><i class="fas fa-list me-1"></i> Key Features</a>
      <a href="#rental" class="btn btn-outline-dark btn-sm"><i class="fas fa-file-contract me-1"></i> Lease / Rental Info</a>
      <a href="#mandate" class="btn btn-outline-dark btn-sm"><i class="fas fa-handshake me-1"></i> Mandate Info</a>
      <a href="#lightgallery" class="btn btn-outline-dark btn-sm"><i class="fas fa-images me-1"></i> Gallery</a>
      <a href="#map" class="btn btn-outline-dark btn-sm"><i class="fas fa-map-marked-alt me-1"></i> Map</a>
    </div>

    <!-- Overview & Seller Side-by-Side -->
    <div class="row mb-5">
      <div class="col-md-8" id="overview">
        <h5 class="mb-3 border-bottom pb-2">Property Overview</h5>
        <p>{{ property.description }}</p>
      </div>
      <div class="col-md-4" id="seller">

        <h5 class="mb-3 border-bottom pb-2">Agent(s) Marketing This Property</h5>

<div class="d-flex flex-column gap-3">

    {# Multiple agents #}
    {% if property.agents.all %}
        {% for agent in property.agents.all %}
            <div class="bg-black bg-opacity-80 text-white p-3 rounded shadow-sm d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-2">
                    {% if agent.userprofile.profile_picture %}
                        <img src="{{ agent.userprofile.profile_picture.url }}" class="rounded-circle border" style="width: 80px; height: 80px; object-fit: cover;">
                    {% elif agent.agency and agent.agency.logo %}
                        <img src="{{ agent.agency.logo.url }}" class="border rounded" style="width: 80px; height: 80px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center text-white fw-bold"
                             style="width: 80px; height: 80px;">
                            {{ agent.username|first|upper }}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <p class="mb-1 fw-semibold">{{ agent.get_full_name|default:agent.username }}</p>
                    {% if agent.agency %}
                        <span class="text-gray-300 small">Agent at {{ agent.agency.name }}</span>
                    {% endif %}
                    <div class="d-flex gap-2 mt-2">
                        {% if agent.userprofile.contact_number %}
                            <a href="{% if user.is_authenticated %}tel:{{ agent.userprofile.contact_number }}{% else %}#{% endif %}" 
                               class="btn btn-outline-light btn-sm contact-btn" 
                               data-login-message="Please login to contact the agent.">
                                <i class="fas fa-phone"></i> Call
                            </a>
                            <a href="{% if user.is_authenticated %}https://wa.me/{{ agent.userprofile.contact_number }}{% else %}#{% endif %}" 
                               class="btn btn-success btn-sm contact-btn" 
                               data-login-message="Please login to contact the agent.">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                        {% endif %}
                        {% if agent.email %}
                            <a href="{% if user.is_authenticated %}mailto:{{ agent.email }}{% else %}#{% endif %}" 
                               class="btn btn-danger btn-sm contact-btn" 
                               data-login-message="Please login to contact the agent.">
                                <i class="fas fa-envelope"></i> Email
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    {# Standalone agent #}
    {% if property.agent and property.agent not in property.agents.all %}
        <!-- keep same block as your original -->
    {% endif %}

    {# Seller fallback #}
    {% if property.seller %}
        <!-- keep same block as your original -->
    {% endif %}

</div>
      </div>
    </div>

   <!-- Key Features -->
{% if property.number_of_bedrooms or property.number_of_bathrooms or property.number_of_kitchens or property.number_of_garages or property.floor_area_m2 or property.erf_size_m2 or property.property_type or property.price_per_m2 or property.price_per_erf_m2 or property.has_parking %}
<div id="features" class="mb-5">
    <h5 class="mb-3 fw-bold text-danger">Key Features</h5>
    <hr>
    <div class="row g-3 bg-white text-dark p-3 rounded">
        {% if property.number_of_bedrooms %}<div class="col-6 col-md-3"><strong>Bedrooms:</strong> {{ property.number_of_bedrooms }}</div>{% endif %}
        {% if property.number_of_bathrooms %}<div class="col-6 col-md-3"><strong>Bathrooms:</strong> {{ property.number_of_bathrooms }}</div>{% endif %}
        {% if property.number_of_kitchens %}<div class="col-6 col-md-3"><strong>Kitchens:</strong> {{ property.number_of_kitchens }}</div>{% endif %}
        {% if property.number_of_garages %}<div class="col-6 col-md-3"><strong>Garages:</strong> {{ property.number_of_garages }}</div>{% endif %}
        {% if property.floor_area_m2 %}<div class="col-6 col-md-3"><strong>Floor Area:</strong> {{ property.floor_area_m2 }} m²</div>{% endif %}
        {% if property.erf_size_m2 %}<div class="col-6 col-md-3"><strong>Erf Size:</strong> {{ property.erf_size_m2 }} m²</div>{% endif %}
        {% if property.property_type %}<div class="col-6 col-md-3"><strong>Property Type:</strong> {{ property.property_type }}</div>{% endif %}
        {% if property.price_per_m2 %}<div class="col-6 col-md-3"><strong>Price per m²:</strong> R {{ property.price_per_m2|floatformat:0 }}</div>{% endif %}
        {% if property.price_per_erf_m2 %}<div class="col-6 col-md-3"><strong>Price per Erf m²:</strong> R {{ property.price_per_erf_m2|floatformat:0 }}</div>{% endif %}
        {% if property.has_parking %}<div class="col-6 col-md-3"><strong>Parking:</strong> Yes {% if property.number_of_parking_slots %}({{ property.number_of_parking_slots }} slots){% endif %}</div>{% endif %}
    </div>
</div>
{% endif %}

<!-- Lease / Rental Info -->
{% if property.listing_type == "Rental" %}
    {% if property.lease_period or property.occupation_date or property.deposit or property.lease_excludes or property.annual_escalation %}
    <div id="rental" class="mb-5">
        <h5 class="mb-3 fw-bold text-danger">Lease / Rental Information</h5>
        <hr>
        <div class="row g-3 bg-white text-dark p-3 rounded">
            {% if property.lease_period %}<div class="col-md-4"><strong>Lease Period:</strong> {{ property.lease_period }}</div>{% endif %}
            {% if property.occupation_date %}<div class="col-md-4"><strong>Occupation Date:</strong> {{ property.occupation_date }}</div>{% endif %}
            {% if property.deposit %}<div class="col-md-4"><strong>Deposit:</strong> R {{ property.deposit }}</div>{% endif %}
            {% if property.lease_excludes %}<div class="col-md-6"><strong>Lease Excludes:</strong> {{ property.lease_excludes }}</div>{% endif %}
            {% if property.annual_escalation %}<div class="col-md-6"><strong>Annual Escalation:</strong> {{ property.annual_escalation }}%</div>{% endif %}
        </div>
    </div>
    {% endif %}
{% endif %}

<!-- Mandate / Commission Info -->
{% if property.mandate_type or property.mandate_start_date or property.mandate_end_date or property.commission_percentage or property.commission_value %}
<div id="mandate" class="mb-5">
    <h5 class="mb-3 fw-bold text-danger">Mandate / Commission Information</h5>
    <hr>
    <div class="row g-3 bg-light text-dark p-3 rounded">
        {% if property.mandate_type %}<div class="col-md-4"><strong>Mandate Type:</strong> {{ property.mandate_type }}</div>{% endif %}
        {% if property.mandate_start_date %}<div class="col-md-4"><strong>Start Date:</strong> {{ property.mandate_start_date }}</div>{% endif %}
        {% if property.mandate_end_date %}<div class="col-md-4"><strong>End Date:</strong> {{ property.mandate_end_date }}</div>{% endif %}
        {% if property.commission_percentage %}<div class="col-md-4"><strong>Commission %:</strong> {{ property.commission_percentage }}%</div>{% endif %}
        {% if property.commission_value %}<div class="col-md-4"><strong>Commission Value:</strong> R {{ property.commission_value }}</div>{% endif %}
    </div>
</div>
{% endif %}

    <!-- Gallery -->
    <h5>Image Gallery</h5>
    <hr>
    <div id="lightgallery" class="row g-3">
      {% for image in images %}
          {% if image.image %}
              <div class="col-6 col-md-3">
                  <a href="{{ image.image.url }}" class="gallery-item">
                      <img src="{{ image.image.url }}" class="img-fluid rounded" alt="Gallery Image">
                  </a>
              </div>
          {% endif %}
      {% endfor %}
    </div>
    <br>
    <h5>Map View</h5>
    <hr>

    <!-- Map View -->
    <div id="map" class="mb-5" style="height: 400px;"></div>
    {% if property.latitude and property.longitude %}
    <script>
      function initMap() {
        const propertyLocation = { lat: {{ property.latitude|default:"0" }}, lng: {{ property.longitude|default:"0" }} };
        const map = new google.maps.Map(document.getElementById('map'), { zoom: 15, center: propertyLocation });
        new google.maps.Marker({ position: propertyLocation, map: map });
      }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCd3bl10Viq12p8pxNP2dPqV-veDWfF5ac&callback=initMap"></script>
    {% else %}
    <div class="rounded-lg shadow-lg w-full h-64 flex items-center justify-center bg-gray-100 text-gray-500 text-center">
      <p>No location coordinates provided for this property.</p>
    </div>
    {% endif %}

    <!-- Other Actions -->
    {# keep your existing Other Actions block unchanged #}

</div>


<div class="mb-5">
    <h5 class="mb-3 border-bottom pb-2">Other Actions</h5>
    <div class="d-flex flex-wrap gap-2">

        <!-- Make Offer -->
        <a href="{% url 'submit_interest' property.id %}"
           class="btn btn-danger btn-sm d-flex align-items-center gap-1">
            <i class="fas fa-handshake"></i> Make Offer
        </a>

        <!-- Request More Info -->
        {% if user.is_authenticated %}
           <a href=""
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-info-circle"></i> Request Info
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to request info">
                <i class="fas fa-info-circle"></i> Request Info
            </a>
        {% endif %}

        <!-- Save Property -->
        {% if user.is_authenticated %}
            <form method="post" action="" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                    <i class="fas fa-bookmark"></i> Save
                </button>
            </form>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to save property">
                <i class="fas fa-bookmark"></i> Save
            </a>
        {% endif %}

        <!-- Share Property -->
        <button type="button"
                class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
                onclick="navigator.clipboard.writeText(window.location.href); alert('Property link copied!')">
            <i class="fas fa-share"></i> Share
        </button>

        <!-- Boost / Promote -->
        {% if user.is_authenticated %}
            <a href=""
               class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-bolt"></i> Boost
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1"
               title="Login to boost property">
                <i class="fas fa-bolt"></i> Boost
            </a>
        {% endif %}

        <!-- Compare Property -->
        <button type="button" class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
                onclick="addToCompare({{ property.id }})">
            <i class="fas fa-exchange-alt"></i> Compare
        </button>

        <!-- Print Property -->
        <button type="button" class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
                onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>

        <!-- Report Property -->
        {% if user.is_authenticated %}
            <a href=""
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-flag"></i> Report
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to report property">
                <i class="fas fa-flag"></i> Report
            </a>
        {% endif %}

        <!-- Request Valuation -->
        {% if user.is_authenticated %}
            <a href=""
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1">
                <i class="fas fa-chart-line"></i> Request Valuation
            </a>
        {% else %}
            <a href="{% url 'login' %}"
               class="btn btn-outline-dark btn-sm d-flex align-items-center gap-1"
               title="Login to request valuation">
                <i class="fas fa-chart-line"></i> Request Valuation
            </a>
        {% endif %}

    </div>
</div>

<!-- LightGallery Script -->
<link href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    lightGallery(document.getElementById("lightgallery"), {
      selector: '.gallery-item', plugins: [lgZoom], mode: 'lg-slide', speed: 600, thumbnail: true, download: false
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>

<!-- JS for login check -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const contactButtons = document.querySelectorAll('.contact-btn');
  contactButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      // If the href is #, user is not logged in
      if (this.getAttribute('href') === '#') {
        e.preventDefault();
        alert(this.dataset.loginMessage);  // Show a simple alert
        // OR redirect to login page if you prefer:
        // window.location.href = "{% url 'login' %}";
      }
    });
  });
});
</script>
{% endblock %}
