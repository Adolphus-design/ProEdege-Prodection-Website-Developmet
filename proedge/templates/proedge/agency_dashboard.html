{% extends "base.html" %}
{% block content %}
<div class="container my-5">

  <!-- Top Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Agency Dashboard</h2>
    <a href="{% url 'edit_agency_profile' %}" class="btn btn-outline-primary">‚úèÔ∏è Edit Agency Profile</a>
  </div>

  <!-- Welcome Banner -->
  <div class="mb-4">
    <h5>Welcome, {{ request.user.get_full_name }}</h5>
    <a href="{% url 'view_agency_profile' %}" class="btn btn-outline-dark btn-sm">üè¢ View Agency</a>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="bg-primary text-white rounded p-3 text-center">
        <strong>Total Listings</strong><br>{{ properties.count }}
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="bg-success text-white rounded p-3 text-center">
        <strong>Approved Agents</strong><br>{{ agents.count }}
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="bg-warning text-dark rounded p-3 text-center">
        <strong>Pending Requests</strong><br>{{ join_requests.count }}
      </div>
    </div>
  </div>

  <div class="text-end mt-3 mb-4">
    <a href="{% url 'submit_property' %}" class="btn btn-primary">+ List New Property</a>
  </div>

  <!-- Agent Join Requests
  <h4>Agent Join Requests</h4>
  <a href="#"><strong>View Requests</strong> {{ join_requests.count }}</a>
  {% if join_requests %}
    <ul class="list-group">
      {% for req in join_requests %}
        <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">

          <div>
            <a href="{% url 'agent_join_request_detail' req.id %}">
              <strong>{{ req.agent.get_full_name|default:req.agent.username }}</strong>
            </a>
            <small class="text-muted">requested to join your agency.</small>
            <br>
            <span class="badge {% if req.is_approved %} bg-success {% elif req.manual_rejection_reason %} bg-danger {% else %} bg-warning {% endif %}">
                {% if req.is_approved %}Approved
                {% elif req.manual_rejection_reason %}Rejected
                {% else %}Pending
                {% endif %}
              </span>
            <br>

           
            <ul class="mt-2">
              {% for doc in req.documents.all %}
                <li>
                  {{ doc.document_type }} - Status: {{ doc.status|title }}
                  {% if doc.status == 'rejected' %}
                    <br><small class="text-danger">Reason: {{ doc.rejection_reason }}</small>
                  {% endif %}
                  <br>
                  <a href="{{ doc.document.url }}" target="_blank">View Document</a> |
                  {% if doc.status != 'approved' %}
                    <a href="{% url 'manual_approve_document' doc.id %}" class="text-success">Approve</a> |
                  {% endif %}
                  {% if doc.status != 'rejected' %}
                    <a href="{% url 'manual_reject_document' doc.id %}" class="text-danger">Reject</a>
                  {% endif %}
                </li>
              {% empty %}
                <li class="text-muted"><em>No documents uploaded.</em></li>
              {% endfor %}
            </ul>
          </div>

          <div class="mt-2 mt-md-0">
            
              <a href="{% url 'approve_join_request' req.id %}" class="btn btn-sm btn-success me-1">Approve</a>
              <a href="{% url 'reject_join_request' req.id %}" class="btn btn-sm btn-danger">Reject</a>
           
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted">No join requests found.</p>
  {% endif %}
  -->

  <div class="d-flex justify-content-between align-items-center mb-3">
  
  <a href="{% url 'create_agent' %}" class="btn btn-sm btn-success">+ Register New Agent</a>
  <a href="{% url 'view_agents' %}" class="btn btn-sm btn-outline-primary">View All Agents</a>
</div>



 

  <!-- Property Listings -->
<div class="mt-4">
  <h4>Your Properties</h4>
  {% if grouped_properties %}
    {% for status, properties in grouped_properties.items %}
      <h5 class="mt-4">{{ status|title }} Listings</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle mt-2">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Location</th>
              <th>Price</th>
              <th>Status</th>
              <th>Agent</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for property in properties %}
              <tr>
                <td>{{ property.title }}</td>
                <td>{{ property.location }}</td>
                <td>R{{ property.price|floatformat:2 }}</td>
                <td><span class="badge bg-secondary">{{ property.status|title }}</span></td>
               <td>
                {% for agent in property.agents.all %}
                  <span class="badge bg-info">{{ agent.get_full_name|default:agent.username }}</span>
                {% empty %}
                  <span class="text-muted">No agents assigned</span>
                {% endfor %}
              </td>
                <td>
                  <a href="{% url 'property_detail' property.pk %}" class="btn btn-sm btn-outline-info">View</a>
                  <a href="{% url 'edit_property' property.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>

                  {% if property.status == 'approved' or property.status == 'available' %}
                    <a href="{% url 'mark_property_sold' property.pk %}" class="btn btn-sm btn-outline-danger">Mark Sold</a>
                  {% elif property.status == 'sold' %}
                    <a href="{% url 'mark_property_available' property.pk %}" class="btn btn-sm btn-outline-success">Mark Available</a>
                  {% endif %}

                  {% if request.user.role == 'agency' %}
                    <a href="{% url 'assign_agent_to_property' property.pk %}" class="btn btn-sm btn-outline-primary">Assign Agent</a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">No properties listed yet.</p>
  {% endif %}
</div>

</div>
{% endblock %}
