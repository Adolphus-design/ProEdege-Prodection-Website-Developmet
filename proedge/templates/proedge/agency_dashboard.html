{% extends "base.html" %}
{% block content %}
<div class="container my-5 text-white" style="background-color: #000; border-radius: 10px; padding: 20px;">

  <!-- Top Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 text-white">Agency Dashboard</h2>
    <a href="{% url 'edit_agency_profile' %}" class="btn btn-danger text-white">‚úèÔ∏è Edit Agency Profile</a>
  </div>

  <!-- Welcome Banner -->
  <div class="mb-4">
    <h5 class="text-white">Welcome, {{ request.user.get_full_name }}</h5>
    <a href="{% url 'view_agency_profile' %}" class="btn btn-danger btn-sm text-white">üè¢ View Agency</a>
  </div>

</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-md-3 col-sm-6">
    <div class="bg-dark text-white rounded p-3 text-center shadow-sm">
      <strong>Total Listings</strong><br>{{ properties.count }}
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="bg-danger text-white rounded p-3 text-center shadow-sm">
      <strong>Approved Agents</strong><br>{{ agents.count }}
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="bg-black text-white rounded p-3 text-center shadow-sm">
      <strong>Pending Requests</strong><br>{{ join_requests.count }}
    </div>
  </div>
</div>

<div class="text-end mt-3 mb-4">
  <a href="{% url 'submit_property' %}" class="btn btn-danger">+ List New Property</a>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <a href="{% url 'create_agent' %}" class="btn btn-sm btn-danger">+ Register New Agent</a>
  <a href="{% url 'view_agents' %}" class="btn btn-sm btn-dark">View All Agents</a>
</div>

<!-- Property Listings -->
<div class="mt-4">
  <h4 class="fw-bold">Your Properties</h4>
  {% if grouped_properties %}
    {% for status, properties in grouped_properties.items %}
      <h5 class="mt-4 text-primary">{{ status|title }} Listings</h5>
      <div class="table-responsive shadow-sm rounded-3">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-dark text-white">
            <tr>
              <th scope="col">Title</th>
              <th scope="col">Location</th>
              <th scope="col">Price</th>
              <th scope="col">Status</th>
              <th scope="col">Listed By</th>
              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for property in properties %}
              <tr>
                <td class="fw-semibold">{{ property.title }}</td>
                <td>{{ property.location }}</td>
                <td class="text-success">R{{ property.price|floatformat:2 }}</td>

                {# --- Polished Status Badge --- #}
                <td>
                  {% if property.status == 'available' or property.status == 'approved' %}
                    <span class="badge bg-success">Available</span>
                  {% elif property.status == 'sold' %}
                    <span class="badge bg-danger">Sold</span>
                  {% elif property.status == 'pending' %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ property.status|title }}</span>
                  {% endif %}
                </td>

                {# --- Corrected 'Listed By' logic: prefer agent -> else agency (and assigned agents) --- #}
                <td>
                  {% if property.agent %}
                    <span class="badge bg-info">{{ property.agent.get_full_name|default:property.agent.username }}</span>
                    <small class="text-muted ms-1">(Listed by agent)</small>

                  {% elif property.agency %}
                    <span class="badge bg-primary">{{ property.agency.name }}</span>
                    <small class="text-muted ms-1">(Listed by agency)</small>

                    {% if property.agents.exists %}
                      <div class="mt-1">
                        {% for agent in property.agents.all %}
                          <span class="badge bg-danger me-1">{{ agent.get_full_name|default:agent.username }}</span>
                        {% endfor %}
                        <small class="text-muted ms-1">(Assigned)</small>
                      </div>
                    {% endif %}

                  {% else %}
                    <span class="text-muted">No agent assigned</span>
                  {% endif %}
                </td>

                {# --- Actions: keep existing urls, polish button styles to ProEdge theme --- #}
                <td class="text-center">
                  <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <a href="{% url 'property_detail' property.pk %}" class="btn btn-sm btn-outline-light text-dark">View</a>

                    <a href="{% url 'edit_property' property.pk %}" class="btn btn-sm btn-danger text-white">Edit</a>

                    {% if property.status == 'approved' or property.status == 'available' %}
                      <a href="{% url 'mark_property_sold' property.pk %}" class="btn btn-sm btn-outline-danger text-danger">Mark Sold</a>
                    {% elif property.status == 'sold' %}
                      <a href="{% url 'mark_property_available' property.pk %}" class="btn btn-sm btn-dark text-white">Mark Available</a>
                    {% endif %}

                    {% if request.user.role == 'agency' %}
                      <a href="{% url 'assign_agent_to_property' property.pk %}" class="btn btn-sm btn-dark text-white">Assign Agent</a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">No properties listed yet.</p>
  {% endif %}
</div>

{% endblock %}
