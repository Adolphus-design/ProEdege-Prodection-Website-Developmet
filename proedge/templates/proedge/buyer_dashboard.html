{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %}Buyer Dashboard{% endblock %}

{% block content %}
<!-- Profile Note -->
  <div class="mb-4">
    <h5>Welcome, {{ request.user.get_full_name }}</h5>
    <a href="{% url 'user_profile' %}" class="btn btn-outline-dark btn-sm">ðŸ‘¤ View Profile</a>
  </div>

 <div class="mb-4 d-flex justify-content-between align-items-center">
    <a href="{% url 'interest_messages' %}" class="btn btn-danger">
      ðŸ’¬ Messages ({{ interests.count }})
    </a>
    <h2 class="mb-0">{{ role }} Dashboard</h2>
     <a href="{% url 'request_join_agency' %}" class="btn btn-primary">Join Agency</a>
  </div>



<h2>Dashboard Summary</h2>
<div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
  <div style="background-color: #4caf50; color: white; padding: 15px; border-radius: 8px; flex: 1;">
    <strong>Saved Properties:</strong> {{ total_listings }}
  </div>
  <div style="background-color: #2196f3; color: white; padding: 15px; border-radius: 8px; flex: 1;">
    <strong>Favorite:</strong> {{ approved_count }}
  </div>
  <div style="background-color: #ff9800; color: white; padding: 15px; border-radius: 8px; flex: 1;">
    <strong>Pending:</strong> {{ pending_count }}
  </div>
  <div style="background-color: #f44336; color: white; padding: 15px; border-radius: 8px; flex: 1;">
    <strong>Rejected:</strong> {{ rejected_count }}
  </div>
  <div style="background-color: #795548; color: white; padding: 15px; border-radius: 8px; flex: 1;">
    <strong>Sold:</strong> {{ sold_count }}
  </div>
</div>

<hr>

<!--Search...Filter-->
<h2 align="center">My Properties</h2>

<form method="get" class="dashboard-filter-bar">
  <input type="text" name="q" placeholder="Search..." value="{{ query|default:'' }}">
  <select name="status">
    <option value="">All Statuses</option>
    <option value="approved" {% if selected_status == 'approved' %}selected{% endif %}>Approved</option>
    <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
    <option value="rejected" {% if selected_status == 'rejected' %}selected{% endif %}>Rejected</option>
    <option value="sold" {% if selected_status == 'sold' %}selected{% endif %}>Sold</option>
    <option value="available" {% if selected_status == 'available' %}selected{% endif %}>Available</option>
  </select>

  <select name="sort">
    <option value="">Sort By</option>
    <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
    <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
    <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>Newest First</option>
    <option value="oldest" {% if request.GET.sort == 'oldest' %}selected{% endif %}>Oldest First</option>
  </select>

  <button type="submit">Apply</button>
</form>

<h1>Auction Properties</h1>
<table>
  <thead>
    <tr>
      <th>Property</th>
      <th>Start</th>
      <th>End</th>
      <th>Min Bid</th>
      <th>Increment</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for auction in auctions %}
      <tr>
        <td>{{ auction.property.title }}</td>
        <td>{{ auction.start_time }}</td>
        <td>{{ auction.end_time }}</td>
        <td>R{{ auction.minimum_bid }}</td>
        <td>R{{ auction.bid_increment }}</td>
        <td>{{ auction.status }}</td>
        <td><a href="{% url 'edit_auction' auction.id %}">Edit Auction</a></td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<h3>Active Auctions</h3>
<ul>
  {% for auction in active_auctions %}
    <li>
      <strong>{{ auction.property.title }}</strong> | Ends: {{ auction.end_time }} |
      Minimum Bid: R{{ auction.minimum_bid }}
    </li>
  {% empty %}
    <li>No active auctions right now.</li>
  {% endfor %}
</ul>

<hr>

<h3>Your Bid History</h3>
<ul>
  {% for bid in bid_history %}
    <li>
      Auction: {{ bid.auction.property.title }} |
      R{{ bid.amount }} on {{ bid.timestamp }}
    </li>
  {% empty %}
    <li>No bids placed yet.</li>
  {% endfor %}
</ul>

<hr>



<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector(".dashboard-filter-bar");

    // Auto-submit on search clear
    const searchInput = form.querySelector("input[name='q']");
    searchInput.addEventListener("input", function () {
      if (this.value === "") {
        form.submit();
      }
    });

    // Auto-submit on filter/sort change
    form.querySelectorAll("select").forEach(function (select) {
      select.addEventListener("change", function () {
        form.submit();
      });
    });
  });
</script>
{% endblock %}
