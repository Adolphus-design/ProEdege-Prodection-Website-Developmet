{% extends "base.html" %}
{% block content %}

<div class="container my-5">

  <!-- Message Button -->
  <div class="mb-4 d-flex justify-content-between align-items-center">
    <a href="{% url 'interest_messages' %}" class="btn btn-danger">
      ðŸ’¬ Messages ({{ interests.count }})
    </a>
    <h2 class="mb-0">{{ role }} Dashboard</h2>
     <a href="{% url 'request_join_agency' %}" class="btn btn-primary">Join Agency</a>
  </div>

  <!-- Interests -->
  {% if interests %}
    <div class="mb-4">
      {% for interest in interests %}
        <div class="border rounded p-3 mb-3 shadow-sm">
          <strong>{{ interest.user.get_full_name|default:interest.user.username }}</strong> is interested in
          <a href="{% url 'property_detail' interest.property.pk %}">{{ interest.property.title }}</a><br>
          <span class="text-muted small">
            Type: {{ interest.interest_type }} | Offer: R{{ interest.offer_price|floatformat:2 }}<br>
            Message: {{ interest.message }}<br>
            Contact: {{ interest.user.userprofile.contact_number|default:"N/A" }}<br>
            Email: {{interest.user.email|default:"N/A"}}
          </span>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No offers or interest submitted yet.</p>
  {% endif %}

  <!-- Profile -->
  <div class="mb-4">
    <h5>Welcome, {{ request.user.get_full_name }}</h5>
     {% if profile.profile_picture %}
        <img src="{{ profile.profile_picture.url }}" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
    {% else %}
        <p>No profile picture uploaded.</p>
    {% endif %}

    <a href="{% url 'user_profile' %}" class="btn btn-outline-dark btn-sm">ðŸ‘¤ View Profile</a>
  </div>

  {% if incomplete_profile %}
    <div class="alert alert-warning">
      Please <a href="{% url 'edit_profile' %}" class="alert-link">complete your profile</a> to unlock full features.
    </div>
  {% endif %}

  <!-- New Listing Button -->
  <div class="text-end mb-3">
    <a href="{% url 'submit_property' %}" class="btn btn-primary">+ List New Property</a>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-5">
    <div class="col-md-2 col-sm-4">
      <div class="bg-success text-white rounded p-3 text-center">
        <strong>Total</strong><br>{{ total_listings }}
      </div>
    </div>
    <div class="col-md-2 col-sm-4">
      <div class="bg-primary text-white rounded p-3 text-center">
        <strong>Approved</strong><br>{{ approved_count }}
      </div>
    </div>
    <div class="col-md-2 col-sm-4">
      <div class="bg-warning text-dark rounded p-3 text-center">
        <strong>Pending</strong><br>{{ pending_count }}
      </div>
    </div>
    <div class="col-md-2 col-sm-4">
      <div class="bg-danger text-white rounded p-3 text-center">
        <strong>Rejected</strong><br>{{ rejected_count }}
      </div>
    </div>
    <div class="col-md-2 col-sm-4">
      <div class="bg-dark text-white rounded p-3 text-center">
        <strong>Sold</strong><br>{{ sold_count }}
      </div>
    </div>
  </div>

  <!-- Filter & Sort -->
  <form method="get" class="row g-2 align-items-center mb-4">
    <div class="col-md-4">
      <input type="text" name="q" class="form-control" placeholder="Search..." value="{{ query|default:'' }}">
    </div>
    <div class="col-md-3">
      <select name="status" class="form-select">
        <option value="">All Statuses</option>
        <option value="approved" {% if selected_status == 'approved' %}selected{% endif %}>Approved</option>
        <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
        <option value="rejected" {% if selected_status == 'rejected' %}selected{% endif %}>Rejected</option>
        <option value="sold" {% if selected_status == 'sold' %}selected{% endif %}>Sold</option>
        <option value="available" {% if selected_status == 'available' %}selected{% endif %}>Available</option>
      </select>
    </div>
    <div class="col-md-3">
      <select name="sort" class="form-select">
        <option value="">Sort By</option>
        <option value="price_asc" {% if request.GET.sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
        <option value="price_desc" {% if request.GET.sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
        <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>Newest First</option>
        <option value="oldest" {% if request.GET.sort == 'oldest' %}selected{% endif %}>Oldest First</option>
      </select>
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-secondary w-100">Apply</button>
    </div>
  </form>

  <!-- Property Listings -->
<div class="mt-4">
  <h4>Your Properties</h4>
  {% if grouped_properties %}
    {% for status, properties in grouped_properties.items %}
      <h5 class="mt-4">{{ status|title }} Listings</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle mt-2">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Location</th>
              <th>Price</th>
              <th>Status</th>
              <th>Listed By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for property in properties %}
              <tr>
                <td>{{ property.title }}</td>
                <td>{{ property.location }}</td>
                <td>R{{ property.price|floatformat:2 }}</td>
                <td>
                  <span class="badge 
                    {% if property.status == 'sold' %}bg-danger
                    {% elif property.status == 'approved' or property.status == 'available' %}bg-success
                    {% else %}bg-secondary{% endif %}">
                    {{ property.status|title }}
                  </span>
                </td>
                <td>
                  {% if property.agent %}
                    <span class="badge bg-info">{{ property.agent.get_full_name|default:property.agent.username }}</span>
                    {% if property.agent != user %}
                      <small class="text-muted">(Assigned)</small>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Assigned</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'property_detail' property.pk %}" class="btn btn-sm btn-outline-info">View</a>
                  <a href="{% url 'edit_property' property.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>

                  {% if property.status == 'approved' or property.status == 'available' %}
                    <a href="{% url 'mark_property_sold' property.pk %}" class="btn btn-sm btn-outline-danger">Mark Sold</a>
                  {% elif property.status == 'sold' %}
                    <a href="{% url 'mark_property_available' property.pk %}" class="btn btn-sm btn-outline-success">Mark Available</a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">No properties assigned or listed yet.</p>
  {% endif %}
</div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const searchInput = form.querySelector("input[name='q']");
    searchInput.addEventListener("input", function () {
      if (this.value === "") form.submit();
    });

    form.querySelectorAll("select").forEach(function (select) {
      select.addEventListener("change", function () {
        form.submit();
      });
    });
  });
</script>

{% endblock %}
